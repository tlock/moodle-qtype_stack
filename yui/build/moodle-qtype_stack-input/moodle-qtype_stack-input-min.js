YUI.add("moodle-qtype_stack-input",function(Y,NAME){var stack_input=function(e,t,n,r){this.input=n,this.validationdiv=r,this.name=e,this.qaid=t,this.input.add_event_handers(this),this.lastvalidatedvalue=this.get_intput_value(),this.validationresults={}};stack_input.prototype.TYPING_DELAY=1e3,stack_input.prototype.input=null,stack_input.prototype.name=null,stack_input.prototype.lastvalidatedvalue="",stack_input.prototype.qaid=null,stack_input.prototype.validationdiv=null,stack_input.prototype.validationresults={},stack_input.prototype.delay_timeout_handle=null,stack_input.prototype.cancel_typing_delay=function(){this.delay_timeout_handle&&clearTimeout(this.delay_timeout_handle),this.delay_timeout_handle=null},stack_input.prototype.value_changing=function(){this.cancel_typing_delay();var e=this;this.show_waiting(),this.delay_timeout_handle=setTimeout(function(){e.value_changed(null)},this.TYPING_DELAY),setTimeout(function(){e.check_no_change()},0)},stack_input.prototype.check_no_change=function(){this.get_intput_value()===this.lastvalidatedvalue&&(this.cancel_typing_delay(),this.validationdiv.removeClass("waiting"))},stack_input.prototype.value_changed=function(){this.cancel_typing_delay(),this.show_validation_results()||this.validate_input()},stack_input.prototype.validate_input=function(){var e=this;Y.io(M.cfg.wwwroot+"/question/type/stack/stack/input/ajax.php",{data:{qaid:this.qaid,name:this.name,input:this.get_intput_value()},on:{success:function(t,n){e.validation_received(n)},failure:function(t,n){e.show_validation_failure(n)}}}),this.show_loading()},stack_input.prototype.get_intput_value=function(){return this.input.get_value()},stack_input.prototype.validation_received=function(e){var t=Y.JSON.parse(e.responseText);if(t.error){this.show_validation_failure(e);return}this.validationresults[t.input]=t,this.show_validation_results()},stack_input.prototype.extract_scripts=function(e,t){var n=/<script[^>]*>([\s\S]*?)<\/script>/g,r;while((r=n.exec(e))!==null)t.push(r[1]);return e.replace(n,"")},stack_input.prototype.show_validation_results=function(){var val=this.get_intput_value();if(!this.validationresults[val])return this.show_waiting(),!1;var results=this.validationresults[val];this.lastvalidatedvalue=val;var scriptcommands=[],html=this.extract_scripts(results.message,scriptcommands);this.validationdiv.setContent(html);for(var i=0;i<scriptcommands.length;i++)eval(scriptcommands[i]);return this.remove_all_classes(),results.message||this.validationdiv.addClass("empty"),Y.fire(M.core.event.FILTER_CONTENT_UPDATED,{nodes:new Y.NodeList(this.validationdiv)}),!0},stack_input.prototype.show_validation_failure=function(e){var t=Y.JSON.parse(e.responseText);this.lastvalidatedvalue="",this.validationdiv.setContent(t.error),this.remove_all_classes(),this.validationdiv.addClass("error")},stack_input.prototype.show_loading=function(){this.remove_all_classes(),this.validationdiv.addClass("loading")},stack_input.prototype.show_waiting=function(){this.remove_all_classes(),this.validationdiv.addClass("waiting")},stack_input.prototype.remove_all_classes=function(){this.validationdiv.removeClass("empty"),this.validationdiv.removeClass("error"),this.validationdiv.removeClass("loading"),this.validationdiv.removeClass("waiting")};var stack_simple_input=function(e){this.input=e};stack_simple_input.prototype.add_event_handers=function(e){this.input.on("valuechange",e.value_changing,e),this.input.on("change",e.value_changing,e)},stack_simple_input.prototype.get_value=function(){return this.input.get("value").replace(/^\s+|\s+$/g,"")};var stack_textarea_input=function(e){this.textarea=e};stack_textarea_input.prototype.add_event_handers=function(e){this.textarea.on("valuechange",e.value_changing,e),this.textarea.on("change",e.value_changing,e)},stack_textarea_input.prototype.get_value=function(){var e=this.textarea.get("value").replace(/^\s+|\s+$/g,"");return"["+e.split(/\s*[\r\n]\s*/).join(",")+"]"};var stack_matrix_input=function(e,t){this.container=t,this.idprefix=e,this.numcol=0,this.numrow=0,this.container.all("input[type=text]").each(function(e){var t=e.get("name");if(t.slice(0,this.idprefix.length+5)!==this.idprefix+"_sub_")return;var n=t.substring(this.idprefix.length+5).split("_");this.numrow=Math.max(this.numrow,parseInt(n[0],10)+1),this.numcol=Math.max(this.numcol,parseInt(n[1],10)+1)},this)};stack_matrix_input.prototype.add_event_handers=function(e){this.container.delegate("valuechange",e.value_changing,"input[type=text]",e),this.container.delegate("change",e.value_changing,"input[type=text]",e)},stack_matrix_input.prototype.get_value=function(){var e=new Array(this.numrow);for(var t=0;t<this.numrow;t++)e[t]=new Array(this.numcol);return this.container.all("input[type=text]").each(function(t){var n=t.get("name");if(n.slice(0,this.idprefix.length+5)!==this.idprefix+"_sub_")return;var r=n.substring(this.idprefix.length+5).split("_");e[r[0]][r[1]]=t.get("value").replace(/^\s+|\s+$/g,"")},this),"matrix(["+e.join("],[")+"])"},M.qtype_stack=M.qtype_stack||{},M.qtype_stack.init_inputs=function(e,t,n){var r=!0;for(var i=0;i<e.length;i++){var s=e[i];r=M.qtype_stack.init_input(s,t,n)&&r}var o=Y.one('input[name="'+n+':sequencecheck"]').ancestor("div.que.stack");if(r&&o&&(o.hasClass("dfexplicitvaildate")||o.hasClass("dfcbmexplicitvaildate"))){var u=o.one(".im-controls input.submit");u.get("id")===n+"-submit"&&u.hide()}},M.qtype_stack.init_input=function(e,t,n){var r=Y.one(document.getElementById(n+e+"_val"));if(!r)return!1;var i=Y.one(document.getElementById(n+e));if(i)return i.get("tagName")==="TEXTAREA"?new stack_input(e,t,new stack_textarea_input(i),r):new stack_input(e,t,new stack_simple_input(i),r),!0;var s=Y.one(document.getElementById(n+e+"_container"));return s?(new stack_input(e,t,new stack_matrix_input(n+e,s),r),!0):!1}},"@VERSION@",{requires:["node","event-valuechange","moodle-core-event","io","json-parse"]});
